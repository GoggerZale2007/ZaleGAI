<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ZaleGAI 1.0</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" defer></script>

    <style>
        :root { --bg: #ffffff; --text: #000000; --blue: #1a73e8; --gray: #f1f3f4; }
        [data-theme="dark"] { --bg: #121212; --text: #ffffff; --blue: #8ab4f8; --gray: #202124; }

        * { box-sizing: border-box; }
        
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            background: var(--bg); 
            color: var(--text);
            overflow: hidden;
            position: fixed; /* Prevents mobile bounce/scroll bugs */
            width: 100%;
        }

        body { 
            display: flex; 
            flex-direction: column; 
            font-family: -apple-system, system-ui, sans-serif;
            height: 100dvh; 
        }

        header { 
            background: var(--blue); 
            color: white; 
            padding: 15px; 
            padding-top: env(safe-area-inset-top);
            text-align: center; 
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        #chat { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px;
            background: var(--bg);
            -webkit-overflow-scrolling: touch;
        }

        .msg { padding: 12px; border-radius: 15px; max-width: 85%; font-size: 16px; line-height: 1.4; }
        .user { align-self: flex-end; background: var(--blue); color: white; }
        .bot { align-self: flex-start; background: var(--gray); color: var(--text); }

        /* THE BAR FIX: High Z-Index and explicit height */
        .input-area { 
            background: var(--bg); 
            border-top: 1px solid #ccc;
            padding: 10px;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
            width: 100%;
            z-index: 9999;
        }

        .input-container {
            display: flex;
            background: var(--gray);
            border-radius: 25px;
            padding: 5px 15px;
            align-items: center;
        }

        input {
            flex: 1;
            border: none;
            background: transparent;
            height: 40px;
            font-size: 16px;
            color: var(--text);
            outline: none;
        }

        button {
            background: none;
            border: none;
            color: var(--blue);
            font-weight: bold;
            font-size: 18px;
            margin-left: 10px;
        }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; }
        .modal-content { background:var(--bg); margin: 20% auto; padding:20px; width:80%; border-radius:10px; }
    </style>
</head>
<body>

<header>
    <div></div>
    <span>ZaleGAI 1.0</span>
    <button onclick="document.getElementById('setModal').style.display='block'" style="color:white">⚙️</button>
</header>

<div id="chat">
    <div class="msg bot">System: ZaleGAI loaded. If you see this, the app is working.</div>
</div>

<div class="input-area">
    <div class="input-container">
        <input type="text" id="userInput" placeholder="Type a message..." autocomplete="off">
        <button onclick="askAI()">Send</button>
    </div>
</div>

<div id="setModal" class="modal">
    <div class="modal-content">
        <h3>Settings</h3>
        <input type="text" id="keyInp" placeholder="Paste API Key" style="width:100%; padding:10px; margin-bottom:10px;">
        <button onclick="saveSet()" style="width:100%; background:var(--blue); color:white; padding:10px; border-radius:5px;">Save</button>
        <button onclick="document.getElementById('setModal').style.display='none'" style="width:100%; margin-top:10px;">Close</button>
    </div>
</div>

<script>
    let API_KEY = localStorage.getItem('z_key') || "";
    let history = [];

    function saveSet() {
        API_KEY = document.getElementById('keyInp').value.trim();
        localStorage.setItem('z_key', API_KEY);
        document.getElementById('setModal').style.display='none';
    }

    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `msg ${sender}`;
        // Simple fallback if libraries haven't loaded yet
        if (sender === 'bot' && window.marked) {
            div.innerHTML = marked.parse(text);
        } else {
            div.textContent = text;
        }
        document.getElementById('chat').appendChild(div);
        document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
    }

    async function askAI() {
        const inp = document.getElementById('userInput');
        const text = inp.value.trim();
        if (!text || !API_KEY) {
            if(!API_KEY) alert("Add API Key in Settings ⚙️");
            return;
        }

        addMessage(text, 'user');
        inp.value = "";
        history.push({ role: "user", parts: [{ text: text }] });

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: history })
            });
            const data = await res.json();
            const aiText = data.candidates[0].content.parts[0].text;
            addMessage(aiText, 'bot');
            history.push({ role: "model", parts: [{ text: aiText }] });
        } catch (e) {
            addMessage("Error connecting to AI.", "bot");
        }
    }
</script>
</body>
</html>
